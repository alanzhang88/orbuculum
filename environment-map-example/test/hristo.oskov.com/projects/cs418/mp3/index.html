<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!-- misteroneill.com/improved-internet-explorer-targeting-through-body-classes/ -->
<!--[if lt IE 7]> <html class="no-js ie ie6 lte9 lte8 lte7" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="no-js ie ie7 lte9 lte8 lte7" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js ie ie8 lte9 lte8" lang="en"> <![endif]-->
<!--[if IE 9]> <html class="no-js ie ie9 lte9" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]>
<!-->
<html class="no-js" lang="en">
<!--<![endif]-->
<head>
    <title>webGL</title>
    
    <!-- favicon -->
    
    <!-- Styles -->
    <link type="text/css" rel="stylesheet" href="css/jQuery-UI.css">
    <link type="text/css" rel="stylesheet" href="css/style.css">
</head>

<body>
    <div id="wrapper">

        <div id="content">
            CS 418 - MP 3
        </div>

        </br>

        <div id="options">

            <span>Normals:</span>
            </br>
            <input type="radio" id="calculated" name="normals" value="calculated">
            <label for="calculated">Calculated</label>
            </br>
            <input type="radio" id="provided" name="normals" value="provided" checked>
            <label for="provided">Provided</label>
            
            </br></br>

            <span>Zoom in (helps with Bump Mapping):</span>
            <div id="zoom"></div>

            <span>Texture:</span>
            </br>
            <input type="radio" id="none" name="texture" value="none">
            <label for="none">None</label>
            </br>
            <input type="radio" id="mirror" name="texture" value="mirror">
            <label for="mirror">Mirror</label>
            </br>
            <input type="checkbox" id="mirror-texture" name="" value="mirror-texture">
            <label for="mirror-texture">Mirror with Texture</label>
            </br>
            <input type="radio" id="earth" name="texture" value="earth">
            <label for="earth">Earth</label>
            </br>
            <input type="radio" id="checkerboard" name="texture" value="checkerboard" checked>
            <label for="checkerboard">Checkerboard</label>
            
            </br></br>
            
            <label for="light">Light:</label>
            <input type="checkbox" id="light" checked>
            </br></br>
            <label for="ambient-intensity">Ambient Intensity</label>
            <div id="ambient-intensity"></div>
            <label for="specular-intensity">Specular Intensity</label>
            <div id="specular-intensity"></div>
            <label for="diffuse-intensity">Diffuse Intensity</label>
            <div id="diffuse-intensity"></div>
            </br>
            
            <label for="environment">Environment:</label>
            <input type="checkbox" id="environment" checked>
            </br>
            <input type="radio" id="london" name="environment-texture" value="london">
            <label for="london">London</label>
            </br>
            <input type="radio" id="e-checkerboard" name="environment-texture" value="e-checkerboard" checked>
            <label for="e-checkerboard">Checkerboard</label>
            </br>
        </div>

        <canvas id="main-canvas" width="600" height="400"></canvas>

        <div id="status"></div>
        </br>

    </div><!-- end #wrapper -->

    <!-- Scripts -->
    <script type="text/javascript" src="js/jQuery.js"></script>
    <script src="js/jQuery-UI.min.js"></script>
    <script src="js/glMatrix.min.js"></script>

    <!-- - - - - - - - - - - - - - - - - -  -->
    <!-- Define vertex and fragment shaders -->
    <!-- - - - - - - - - - - - - - - - - -  -->

    <!-- Fragment shader -->
    <script id="shader-fs" type="x-shader/x-fragment">
        precision mediump float;

        varying vec4 vPosition;
        varying vec2 vTextureCoord;
        varying vec3 vTransformedNormal;

        uniform bool uUseLight;
        uniform bool uUseTextures;
        uniform bool uUseEnvironmentTexture;
        uniform bool uShowSpecularHighlights;
        uniform bool uUseEnvironmentReflection;
        uniform bool uUseEnvironmentReflectionAndTexture;

        uniform vec3 uAmbientColor;
        uniform vec3 uPointLightLocation;
        uniform vec3 uPointLightSpecularColor;
        uniform vec3 uPointLightDiffuseColor;
        
        uniform sampler2D uTextureMapSampler;
        uniform sampler2D uTextureBumpMapSampler;
        uniform sampler2D front;
        uniform sampler2D back;
        uniform sampler2D top;
        uniform sampler2D bottom;
        uniform sampler2D right;
        uniform sampler2D left;

        uniform samplerCube uCubeSampler;

        uniform float uMaterialShininess;

        varying float vFace;

        void main(void) {

            vec3 lightWeighting;
            if (!uUseLight) {
                
                lightWeighting = vec3(1.0, 1.0, 1.0); // full brightness

            } else {

                vec3 lightDirection = normalize(uPointLightLocation - vPosition.xyz);
                vec3 normal = normalize(vTransformedNormal);

                float specularLightWeighting = 0.0;
                vec3 eyeDirection = normalize(-vPosition.xyz);
                vec3 reflectionDirection = reflect(-lightDirection, normal);

                if (uShowSpecularHighlights) {

                    // specular highlighting + bump mapping
                    float shininess = texture2D(uTextureBumpMapSampler, vec2(vTextureCoord.s, vTextureCoord.t)).r * 255.0 / uMaterialShininess;
                    if (shininess < 255.0) {
                        specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), shininess * 2.0);
                    }
                } else {

                    // just specular highlighting
                    specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uMaterialShininess);                
                }

                float diffuseLightWeighting = max(dot(normal, lightDirection), 0.0);
                lightWeighting = uAmbientColor
                    + uPointLightSpecularColor * specularLightWeighting
                    + uPointLightDiffuseColor * diffuseLightWeighting;
            }

            vec4 fragmentColor;
            if (uUseTextures) {

                if (vFace < 0.1) {

                    vec4 textureValue = texture2D(uTextureMapSampler, vec2(vTextureCoord.s, vTextureCoord.t));
                    
                    if (uUseEnvironmentReflection) {

                        vec3 normal = normalize(vTransformedNormal);
                        vec3 eyeDirection = normalize(-vPosition.xyz);
                        vec3 lookup = reflect(eyeDirection, normal);
                        fragmentColor = textureCube(uCubeSampler, -lookup);

                        if (uUseEnvironmentReflectionAndTexture) {

                            fragmentColor = fragmentColor * textureValue;
                        }

                    } else {

                        fragmentColor = textureValue;
                    }

                } else if (vFace < 1.1) {
                    fragmentColor = texture2D(front, vTextureCoord);
                } else if (vFace < 2.1) {
                    fragmentColor = texture2D(back, vTextureCoord);
                } else if (vFace < 3.1) {
                    fragmentColor = texture2D(top, vTextureCoord);
                } else if (vFace < 4.1) {
                    fragmentColor = texture2D(bottom, vTextureCoord);
                } else if (vFace < 5.1) {
                    fragmentColor = texture2D(right, vTextureCoord);
                } else {
                    fragmentColor = texture2D(left, vTextureCoord);
                }

            } else {

                fragmentColor = vec4(1.0, 1.0, 1.0, 1.0); // white
            }

            gl_FragColor = vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a);        
        }
    </script>

    <!-- Vertex shader -->
    <script id="shader-vs" type="x-shader/x-vertex">
        attribute vec3 aVertexPosition;
        attribute vec3 aVertexNormal;
        attribute vec2 aTextureCoord;
        attribute float aFace;

        uniform mat4 uMVMatrix;
        uniform mat4 uPMatrix;
        uniform mat3 uNMatrix;

        varying vec2 vTextureCoord;
        varying vec3 vTransformedNormal;
        varying vec4 vPosition;

        varying float vFace;

        void main(void) {
            vPosition = uMVMatrix * vec4(aVertexPosition, 1.0);
            gl_Position = uPMatrix * vPosition;
            vTextureCoord = aTextureCoord;
            vTransformedNormal = uNMatrix * aVertexNormal;
            vFace = aFace;
        }
    </script>

    <script src="js/mp3.js"></script>
    <script type="text/javascript">

        $(document).ready(function() {
            $("#zoom").slider();
            $("#ambient-intensity").slider();
            $("#specular-intensity").slider();
            $("#diffuse-intensity").slider();
            MP.initialize();
        });

    </script>

</body>
</html>